---
# ==============================================================================
# SECTION 1.2 - Package Management (Configure Package Manager)
# ==============================================================================

# 1.2.1 - Ensure GPG is installed
- name: "1.2.1 | Ensure GPG is installed"
  ansible.builtin.package:
    name: gpg
    state: present
  tags:
    - cis_1.2.1
    - packages
    - level1

# 1.2.2 - Configure Package Manager Repositories (Permissions only)
# Note: On ne modifie pas le contenu des sources, mais on sécurise les fichiers.
- name: "1.2.2 | Ensure permissions on /etc/apt/sources.list are configured"
  ansible.builtin.file:
    path: /etc/apt/sources.list
    owner: root
    group: root
    mode: '0644'
  tags:
    - cis_1.2.2
    - packages
    - scored

- name: "1.2.2 | Ensure permissions on /etc/apt/sources.list.d are configured"
  ansible.builtin.file:
    path: /etc/apt/sources.list.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - cis_1.2.2
    - packages
    - scored

# 1.2.3 - Verify Package Integrity using GPG
# Debian le fait par défaut, mais on s'assure que la conf n'est pas désactivée
# On vérifie qu'on n'autorise PAS les dépôts non sécurisés.
- name: "1.2.3 | Ensure checking of GPG keys is globally enforced (apt.conf)"
  ansible.builtin.lineinfile:
    path: /etc/apt/apt.conf.d/99cis-security
    create: yes
    line: 'Acquire::AllowInsecureRepositories "false";'
    owner: root
    group: root
    mode: '0644'
  tags:
    - cis_1.2.3
    - packages
    - level1

- name: "1.2.3 | Ensure checking of unsigned packages is disabled (apt.conf)"
  ansible.builtin.lineinfile:
    path: /etc/apt/apt.conf.d/99cis-security
    line: 'Acquire::AllowDowngradeToInsecureRepositories "false";'
    create: yes
  tags:
    - cis_1.2.3
    - packages
    - level1

# OPTIONNEL : Nettoyage des paquets inutilisés (Bonne pratique, pas toujours strict CIS)
- name: "1.2.x | Remove unused packages (autoremove)"
  ansible.builtin.apt:
    autoremove: yes
  when: cis_level | int >= 2  # Uniquement si on est en mode strict
  tags:
    - maintenance
    - packages